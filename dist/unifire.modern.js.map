{"version":3,"file":"unifire.modern.js","sources":["../src/experiments/modules.js"],"sourcesContent":["export default function Unifire (modules) {\n  const SUBSCRIPTIONS = {};\n  const ACTIONS = {};\n  const BARE_STATE = {};\n  let DEPS = new Set();\n  let PENDING_DELTA = {};\n  let prior;\n  let timeout;\n\n  const STATE = new Proxy(BARE_STATE, {\n    get (state, prop) {\n      return isFunc(state[prop]) ? state[prop](STATE) : state[prop]\n    },\n    set (state, prop, next) {\n      if (!isFunc(state[prop]) && state[prop] !== next) {\n        state[prop] = PENDING_DELTA[prop] = next;\n        callUniqueSubscribers();\n      }\n      return true;\n    }\n  });\n\n  const isFunc = (val) => val instanceof Function;\n\n  const deref = (obj, target = {}) => Object.assign(target, obj);\n\n  const subscribe = (cb, override) => {\n    // This is slightly smaller than Array.isArray\n    if (cb instanceof Array) {\n      DEPS = new Set(cb);\n    } else {\n      DEPS.clear();\n      cb(new Proxy({}, {\n        get (_, prop) {\n          DEPS.add(prop);\n          return STATE[prop];\n        }\n      }), {});\n    }\n    DEPS.forEach((dep) => SUBSCRIPTIONS[dep] && SUBSCRIPTIONS[dep].add(override || cb));\n    return () => DEPS.forEach((dep) => SUBSCRIPTIONS[dep] && SUBSCRIPTIONS[dep].delete(override || cb));\n  }\n\n  const callUniqueSubscribers = () => {\n    // Inlining the debounce function is smaller\n    clearTimeout(timeout);\n    timeout = setTimeout(() => {\n      const uniqueSubscribers = new Set();\n      for (const prop in PENDING_DELTA) {\n        PENDING_DELTA[prop] !== prior[prop]\n        && SUBSCRIPTIONS[prop]\n        && SUBSCRIPTIONS[prop].forEach((sub) => uniqueSubscribers.add(sub));\n      }\n      uniqueSubscribers.forEach((sub) => sub(STATE, prior));\n      PENDING_DELTA = {};\n      prior = deref(STATE);\n    });\n  }\n\n  const fire = (actionName, payload) => {\n    return ACTIONS[actionName] && ACTIONS[actionName]({ state: STATE, fire }, payload);\n  }\n\n  const register = (modules) => {\n    if (!(modules instanceof Array)) modules = [ modules ];\n    for (const { state, actions, subscribers } in modules) {\n      for (const prop in state) SUBSCRIPTIONS[prop] = new Set();\n      deref(actions, ACTIONS);\n      deref(state, STATE);\n      prior = deref(STATE);\n      for (const prop in state) {\n        if (isFunc(state[prop])) {\n          subscribe(state[prop], () => SUBSCRIPTIONS[prop].forEach((sub) => sub(STATE, prior)));\n        }\n      }\n      for (const sub in subscribers) subscribe(sub);\n    }\n  }\n\n  register(modules);\n\n  return { state: STATE, fire, subscribe, register };\n}\n"],"names":["modules","SUBSCRIPTIONS","ACTIONS","prior","timeout","DEPS","Set","PENDING_DELTA","STATE","Proxy","get","state","prop","isFunc","set","next","callUniqueSubscribers","val","Function","deref","obj","target","Object","assign","subscribe","cb","override","Array","clear","_","add","forEach","dep","delete","clearTimeout","setTimeout","uniqueSubscribers","sub","fire","actionName","payload","register","actions","subscribers"],"mappings":"wBAAiCA,GAC/B,MAAMC,EAAgB,GAChBC,EAAU,GAEhB,IAEIC,EACAC,EAHAC,EAAO,IAAIC,IACXC,EAAgB,GAIpB,MAAMC,EAAQ,IAAIC,MANC,GAMiB,CAClCC,IAAG,CAAEC,EAAOC,IACHC,EAAOF,EAAMC,IAASD,EAAMC,GAAMJ,GAASG,EAAMC,GAE1DE,IAAG,CAAEH,EAAOC,EAAMG,KACXF,EAAOF,EAAMC,KAAUD,EAAMC,KAAUG,IAC1CJ,EAAMC,GAAQL,EAAcK,GAAQG,EACpCC,WAMAH,EAAUI,GAAQA,aAAeC,SAEjCC,EAAQ,CAACC,EAAKC,EAAS,KAAOC,OAAOC,OAAOF,EAAQD,GAEpDI,EAAY,CAACC,EAAIC,KAEjBD,aAAcE,MAChBtB,EAAO,IAAIC,IAAImB,IAEfpB,EAAKuB,QACLH,EAAG,IAAIhB,MAAM,GAAI,CACfC,IAAG,CAAEmB,EAAGjB,KACNP,EAAKyB,IAAIlB,GACFJ,EAAMI,MAEb,KAENP,EAAK0B,QAASC,GAAQ/B,EAAc+B,IAAQ/B,EAAc+B,GAAKF,IAAIJ,GAAYD,IACxE,IAAMpB,EAAK0B,QAASC,GAAQ/B,EAAc+B,IAAQ/B,EAAc+B,GAAKC,OAAOP,GAAYD,KAG3FT,EAAwB,KAE5BkB,aAAa9B,GACbA,EAAU+B,WAAW,KACnB,MAAMC,EAAoB,IAAI9B,IAC9B,IAAK,MAAMM,KAAQL,EACjBA,EAAcK,KAAUT,EAAMS,IAC3BX,EAAcW,IACdX,EAAcW,GAAMmB,QAASM,GAAQD,EAAkBN,IAAIO,IAEhED,EAAkBL,QAASM,GAAQA,EAAI7B,EAAOL,IAC9CI,EAAgB,GAChBJ,EAAQgB,EAAMX,MAIZ8B,EAAO,CAACC,EAAYC,IACjBtC,EAAQqC,IAAerC,EAAQqC,GAAY,CAAE5B,MAAOH,EAAO8B,KAAAA,GAAQE,GAGtEC,EAAYzC,IACVA,aAAmB2B,QAAQ3B,EAAU,CAAEA,IAC7C,IAAK,MAAMW,MAAEA,EAAF+B,QAASA,EAATC,YAAkBA,KAAiB3C,EAAS,CACrD,IAAK,MAAMY,KAAQD,EAAOV,EAAcW,GAAQ,IAAIN,IACpDa,EAAMuB,EAASxC,GACfiB,EAAMR,EAAOH,GACbL,EAAQgB,EAAMX,GACd,IAAK,MAAMI,KAAQD,EACbE,EAAOF,EAAMC,KACfY,EAAUb,EAAMC,GAAO,IAAMX,EAAcW,GAAMmB,QAASM,GAAQA,EAAI7B,EAAOL,KAGjF,IAAK,MAAMkC,KAAOM,EAAanB,EAAUa,KAM7C,OAFAI,EAASzC,GAEF,CAAEW,MAAOH,EAAO8B,KAAAA,EAAMd,UAAAA,EAAWiB,SAAAA"}