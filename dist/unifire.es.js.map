{"version":3,"file":"unifire.es.js","sources":["../src/experiments/modules.js"],"sourcesContent":["export default function Unifire (modules) {\n  const SUBSCRIPTIONS = {};\n  const ACTIONS = {};\n  const BARE_STATE = {};\n  let DEPS = new Set();\n  let PENDING_DELTA = {};\n  let prior;\n  let timeout;\n\n  const STATE = new Proxy(BARE_STATE, {\n    get (state, prop) {\n      return isFunc(state[prop]) ? state[prop](STATE) : state[prop]\n    },\n    set (state, prop, next) {\n      if (!isFunc(state[prop]) && state[prop] !== next) {\n        state[prop] = PENDING_DELTA[prop] = next;\n        callUniqueSubscribers();\n      }\n      return true;\n    }\n  });\n\n  const isFunc = (val) => val instanceof Function;\n\n  const deref = (obj, target = {}) => Object.assign(target, obj);\n\n  const subscribe = (cb, override) => {\n    // This is slightly smaller than Array.isArray\n    if (cb instanceof Array) {\n      DEPS = new Set(cb);\n    } else {\n      DEPS.clear();\n      cb(new Proxy({}, {\n        get (_, prop) {\n          DEPS.add(prop);\n          return STATE[prop];\n        }\n      }), {});\n    }\n    DEPS.forEach((dep) => SUBSCRIPTIONS[dep] && SUBSCRIPTIONS[dep].add(override || cb));\n    return () => DEPS.forEach((dep) => SUBSCRIPTIONS[dep] && SUBSCRIPTIONS[dep].delete(override || cb));\n  }\n\n  const callUniqueSubscribers = () => {\n    // Inlining the debounce function is smaller\n    clearTimeout(timeout);\n    timeout = setTimeout(() => {\n      const uniqueSubscribers = new Set();\n      for (const prop in PENDING_DELTA) {\n        PENDING_DELTA[prop] !== prior[prop]\n        && SUBSCRIPTIONS[prop]\n        && SUBSCRIPTIONS[prop].forEach((sub) => uniqueSubscribers.add(sub));\n      }\n      uniqueSubscribers.forEach((sub) => sub(STATE, prior));\n      PENDING_DELTA = {};\n      prior = deref(STATE);\n    });\n  }\n\n  const fire = (actionName, payload) => {\n    return ACTIONS[actionName] && ACTIONS[actionName]({ state: STATE, fire }, payload);\n  }\n\n  const register = (modules) => {\n    if (!(modules instanceof Array)) modules = [ modules ];\n    for (const { state, actions, subscribers } in modules) {\n      for (const prop in state) SUBSCRIPTIONS[prop] = new Set();\n      deref(actions, ACTIONS);\n      deref(state, STATE);\n      prior = deref(STATE);\n      for (const prop in state) {\n        if (isFunc(state[prop])) {\n          subscribe(state[prop], () => SUBSCRIPTIONS[prop].forEach((sub) => sub(STATE, prior)));\n        }\n      }\n      for (const sub in subscribers) subscribe(sub);\n    }\n  }\n\n  register(modules);\n\n  return { state: STATE, fire, subscribe, register };\n}\n"],"names":["modules","prior","timeout","SUBSCRIPTIONS","ACTIONS","DEPS","Set","PENDING_DELTA","STATE","Proxy","get","state","prop","isFunc","set","next","callUniqueSubscribers","val","Function","deref","obj","target","Object","assign","subscribe","cb","override","Array","clear","_","add","forEach","dep","clearTimeout","setTimeout","uniqueSubscribers","sub","register","actions","subscribers","fire","actionName","payload"],"mappings":"wBAAiCA,GAC/B,IAKIC,EACAC,EANEC,EAAgB,GAChBC,EAAU,GAEZC,EAAO,IAAIC,IACXC,EAAgB,GAIdC,EAAQ,IAAIC,MANC,GAMiB,CAClCC,aAAKC,EAAOC,GACV,OAAOC,EAAOF,EAAMC,IAASD,EAAMC,GAAMJ,GAASG,EAAMC,IAE1DE,aAAKH,EAAOC,EAAMG,GAKhB,OAJKF,EAAOF,EAAMC,KAAUD,EAAMC,KAAUG,IAC1CJ,EAAMC,GAAQL,EAAcK,GAAQG,EACpCC,WAMAH,EAAS,SAACI,UAAQA,aAAeC,UAEjCC,EAAQ,SAACC,EAAKC,mBAAAA,IAAAA,EAAS,IAAOC,OAAOC,OAAOF,EAAQD,IAEpDI,EAAY,SAACC,EAAIC,GAcrB,OAZID,aAAcE,MAChBtB,EAAO,IAAIC,IAAImB,IAEfpB,EAAKuB,QACLH,EAAG,IAAIhB,MAAM,GAAI,CACfC,aAAKmB,EAAGjB,GAEN,OADAP,EAAKyB,IAAIlB,GACFJ,EAAMI,MAEb,KAENP,EAAK0B,QAAQ,SAACC,UAAQ7B,EAAc6B,IAAQ7B,EAAc6B,GAAKF,IAAIJ,GAAYD,uBAClEpB,EAAK0B,QAAQ,SAACC,UAAQ7B,EAAc6B,IAAQ7B,EAAc6B,UAAYN,GAAYD,OAG3FT,EAAwB,WAE5BiB,aAAa/B,GACbA,EAAUgC,WAAW,WACnB,IAAMC,EAAoB,IAAI7B,IAC9B,IAAK,IAAMM,KAAQL,EACjBA,EAAcK,KAAUX,EAAMW,IAC3BT,EAAcS,IACdT,EAAcS,GAAMmB,QAAQ,SAACK,UAAQD,EAAkBL,IAAIM,KAEhED,EAAkBJ,QAAQ,SAACK,UAAQA,EAAI5B,EAAOP,KAC9CM,EAAgB,GAChBN,EAAQkB,EAAMX,MAQZ6B,EAAW,SAACrC,GAEhB,aADMA,aAAmB2B,QAAQ3B,EAAU,CAAEA,IACCA,EAAS,KAA1CW,IAAAA,MAAO2B,IAAAA,QAASC,IAAAA,YAC3B,IAAK,IAAM3B,KAAQD,EAAOR,EAAcS,GAAQ,IAAIN,IACpDa,EAAMmB,EAASlC,GACfe,EAAMR,EAAOH,GACbP,EAAQkB,EAAMX,GAJuC,eAK1CI,GACLC,EAAOF,EAAMC,KACfY,EAAUb,EAAMC,GAAO,kBAAMT,EAAcS,GAAMmB,QAAQ,SAACK,UAAQA,EAAI5B,EAAOP,QAFjF,IAAK,IAAMW,KAAQD,IAARC,GAKX,IAAK,IAAMwB,KAAOG,EAAaf,EAAUY,KAM7C,OAFAC,EAASrC,GAEF,CAAEW,MAAOH,EAAOgC,KAtBV,SAAPA,EAAQC,EAAYC,GACxB,OAAOtC,EAAQqC,IAAerC,EAAQqC,GAAY,CAAE9B,MAAOH,EAAOgC,KAAAA,GAAQE,IAqB/ClB,UAAAA,EAAWa,SAAAA"}